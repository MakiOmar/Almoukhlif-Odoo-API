# دليل التكامل مع أودو (Odoo Integration Guide)

## نظرة عامة على التكامل

هذا الإضافي يوفر تكاملاً شاملاً بين ووردبريس/ووكومرس ونظام إدارة الأعمال أودو (Odoo). يسمح التكامل بإرسال الطلبات تلقائياً من ووكومرس إلى أودو، وإدارة المخزون، وتتبع حالة الطلبات.

## كيفية عمل التكامل

### 1. عملية المصادقة (Authentication)
- يتم الحصول على رمز مصادقة من أودو عبر نقطة النهاية `web/session/erp_authenticate`
- يتم تخزين الرمز في الذاكرة المؤقتة لمدة 24 ساعة
- يتم استخدام الرمز في جميع الطلبات اللاحقة إلى أودو

### 2. إرسال الطلبات
- عند إنشاء طلب جديد في ووكومرس، يتم إرساله تلقائياً إلى أودو
- يتم تجميع بيانات الطلب بما في ذلك:
  - معلومات العميل (الاسم، العنوان، البريد الإلكتروني، الهاتف)
  - منتجات الطلب (SKU، الكمية، السعر، الخصم)
  - معلومات الشحن والضرائب
  - الكوبونات المطبقة

### 3. معالجة الاستجابة
- يتم معالجة استجابة أودو وتحديث حالة الطلب في ووكومرس
- في حالة النجاح، يتم حفظ معرف أودو ورقم الطلب
- في حالة الفشل، يتم تسجيل الخطأ وإعادة المحاولة

## نقاط النهاية (Endpoints)

### نقاط النهاية الخارجية (أودو → ووردبريس)

#### 1. تحديث المخزون
```
POST /wp-json/odoo/v1/update-stock
```
**البيانات المطلوبة:**
- `sku`: رمز المنتج
- `stock`: الكمية المتوفرة

**الاستجابة:**
```json
{
  "success": true,
  "message": "تم تحديث المخزون بنجاح",
  "sku": "PRODUCT-001",
  "stock": 50
}
```

#### 2. تحديث حالة الطلب
```
POST /wp-json/odoo/v1/set-order-status
```
**البيانات المطلوبة:**
- `order_id`: معرف الطلب في ووكومرس
- `status`: الحالة الجديدة

**الاستجابة:**
```json
{
  "success": true,
  "message": "تم تحديث حالة الطلب بنجاح",
  "order_id": 123,
  "status": "processing"
}
```

#### 3. تحديث بيانات الطلب
```
POST /wp-json/odoo/v1/update-order-meta
```
**البيانات المطلوبة:**
- `order_id`: معرف الطلب في ووكومرس
- `odoo_order_id`: معرف الطلب في أودو
- `odoo_order_number`: رقم الطلب في أودو

#### 4. إدارة حالة أودو
```
POST /wp-json/odoo/v1/set-odoo-status
```
**البيانات المطلوبة:**
- `order_id`: معرف الطلب
- `status`: الحالة الجديدة
- `action`: نوع الإجراء (cancel/ship/update)

### نقاط النهاية الداخلية (ووردبريس → أودو)

#### 1. إرسال/تحديث الطلبات
```
POST {ODOO_BASE}/api/sale.order/add_update_order
```
**البيانات المرسلة:**
```json
{
  "orders": [
    {
      "woo_commerce_id": 123,
      "manual_confirm": false,
      "note": "ملاحظات العميل",
      "state": "draft",
      "billing": {
        "first_name": "أحمد",
        "last_name": "محمد",
        "address_1": "شارع الملك فهد",
        "city": "الرياض",
        "state": "الرياض",
        "postcode": "12345",
        "country": "SA",
        "email": "ahmed@example.com",
        "phone": "+966501234567"
      },
      "order_line": [
        {
          "default_code": "PRODUCT-001",
          "name": "اسم المنتج",
          "product_uom_qty": 2,
          "price_unit": 100.00,
          "discount": 10.00
        }
      ],
      "payment_method": "بطاقة ائتمان",
      "wc_order_status": "معلق",
      "wc_order_status_code": "pending",
      "is_vat_exmpt": true,
      "created_date": "2024-01-15 10:30:00"
    }
  ]
}
```

#### 2. إلغاء الطلب
```
POST {ODOO_BASE}/api/sale.order/cancel_order
```
**البيانات المرسلة:**
```json
{
  "orders": [
    {
      "RequestID": "12345"
    }
  ]
}
```

#### 3. تأكيد التسليم
```
POST {ODOO_BASE}/api/sale.order/validate_order_delivery
```
**البيانات المرسلة:**
```json
{
  "orders": [
    {
      "RequestID": "12345",
      "modified_date": "2024-01-15 15:30:00"
    }
  ]
}
```

#### 4. استعلام المخزون
```
POST {ODOO_BASE}/api/stock.quant/get_available_qty_data
```
**البيانات المرسلة:**
```json
{
  "default_code": "PRODUCT-001",
  "location_id": "1"
}
```

## الأحداث (Events)

### أحداث ووردبريس

#### 1. إنشاء الطلب
```php
add_action('woocommerce_checkout_order_created', 'on_order_created');
```
- يتم تشغيله عند إنشاء طلب جديد
- يرسل الطلب تلقائياً إلى أودو

#### 2. تحديث الطلب
```php
add_action('woocommerce_process_shop_order_meta', 'on_order_updated');
```
- يتم تشغيله عند تحديث بيانات الطلب
- يرسل التحديثات إلى أودو

#### 3. تغيير حالة الطلب
```php
add_action('woocommerce_order_status_changed', 'on_order_status_changed');
```
- يتم تشغيله عند تغيير حالة الطلب
- يتعامل مع حالات خاصة مثل الإلغاء والتسليم

#### 4. أحداث مخصصة
```php
do_action('odoo_order_sent', $order_id, $response_data);
do_action('odoo_order_failed', $order_id, $error_data);
```
- يتم تشغيلها عند نجاح أو فشل إرسال الطلب

### أحداث أودو

#### 1. استجابة إرسال الطلب
```json
{
  "result": {
    "Code": 200,
    "Data": [
      {
        "woo_commerce_id": 123,
        "ID": 456,
        "Number": "SO-2024-001",
        "StatusDescription": "Success"
      }
    ]
  }
}
```

#### 2. استجابة فشل الطلب
```json
{
  "result": {
    "Code": 400,
    "Data": [
      {
        "woo_commerce_id": 123,
        "ID": false,
        "StatusDescription": "Failed",
        "ArabicMessage": "خطأ في معالجة الطلب",
        "EnglishMessage": "Error processing order"
      }
    ]
  }
}
```

## إدارة المخزون

### التحقق من المخزون
- يتم التحقق من توفر المخزون قبل إضافة المنتج إلى السلة
- يتم مراعاة المضاعف (multiplier) للمنتجات المتغيرة
- يتم عرض رسائل خطأ مناسبة عند عدم توفر المخزون

### تحديث المخزون
- يتم تحديث المخزون في ووكومرس بناءً على البيانات الواردة من أودو
- يتم التحقق من صحة البيانات قبل التحديث
- يتم تسجيل جميع عمليات تحديث المخزون

## الأمان والتحقق

### التحقق من API Key
- يتم التحقق من مفتاح API في جميع الطلبات الواردة
- يتم استخدام `x-api-key` في رؤوس الطلب
- يتم مقارنة المفتاح مع المفتاح المخزن في إعدادات الموقع

### التحقق من Nonce
- يتم استخدام nonce للتحقق من صحة الطلبات AJAX
- يتم إنشاء nonce فريد لكل طلب
- يتم التحقق من صحة nonce قبل معالجة الطلب

## التسجيل والمراقبة

### سجلات النشاط
- يتم تسجيل جميع عمليات إرسال الطلبات
- يتم تسجيل تغييرات حالة الطلبات
- يتم تسجيل أخطاء الاتصال والمصادقة

### معلومات التتبع
- معرف المستخدم الذي قام بالإجراء
- عنوان IP للمستخدم
- User Agent للمتصفح
- الوقت والتاريخ الدقيق
- مصدر الطلب (Admin/AJAX/CRON/REST API)

## إعدادات التكوين

### متغيرات البيئة المطلوبة
```php
define('ODOO_BASE', 'https://your-odoo-instance.com/');
define('ODOO_DATABASE', 'your_database_name');
define('ODOO_LOGIN', 'your_username');
define('ODOO_PASS', 'your_password');
define('ODOO_LOCATION', '1');
```

### إعدادات إضافية
- مفتاح API للاتصال الخارجي
- إعدادات إعادة المحاولة
- إعدادات المهلة الزمنية
- إعدادات التسجيل

## استكشاف الأخطاء

### مشاكل شائعة
1. **فشل المصادقة**: التحقق من صحة بيانات تسجيل الدخول
2. **فشل الاتصال**: التحقق من إمكانية الوصول إلى خادم أودو
3. **أخطاء في البيانات**: التحقق من صحة بيانات الطلب
4. **مشاكل المخزون**: التحقق من إعدادات إدارة المخزون

### أدوات التشخيص
- سجلات الأخطاء في ووردبريس
- سجلات النشاط المخصصة
- أدوات مراقبة الأداء
- اختبارات الاتصال

## الدعم والمساعدة

للحصول على المساعدة أو الإبلاغ عن مشاكل:
- راجع سجلات الأخطاء أولاً
- تحقق من إعدادات الاتصال
- تأكد من صحة بيانات المصادقة
- راجع وثائق أودو API

---

*هذا الدليل يغطي الجوانب الأساسية للتكامل بين ووردبريس وأودو. للحصول على معلومات أكثر تفصيلاً، راجع الكود المصدري أو تواصل مع فريق الدعم.* 